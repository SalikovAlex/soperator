service: ui
title: Docs builder

shared:
  common_environment_secrets: &common_environment_secrets
    YFM_STORAGE_KEY_ID: secret/users/svc-ui-ci@nebius.com/secrets#docs_viewer_access_key_id_stable
    YFM_STORAGE_SECRET_KEY: secret/users/svc-ui-ci@nebius.com/secrets#docs_viewer_secret_key_id_stable
  common_environment_variables: &common_environment_variables
    PROJECT: slurm_operator
    ARCADIA_PATH: ../../../../..
    DOCS_SOURCE: ./source
    ENV: stable

ci:
  secret: secret/users/svc-ui-ci@nebius.com/secrets
  runtime:
    sandbox-owner: UI

  permissions:
    start-flow:
      - service: ui
    manual-trigger:
      - service: ui

  actions:
    preview_docs:
      title: Preview docs (slurm_operator)
      flow: preview_docs
      triggers:
        - on: pr
          required: true
    release_docs:
      title: Release docs
      flow: release_docs
      triggers:
        - on: commit
          into:
            - trunk

  flows:
    release_docs:
      title: Release docs (slurm_operator)
      jobs:
        docs:
          title: Build and Upload docs
          task: common/npm/run
          input:
            config:
              script: release:docs
              secret_environment_variables: *common_environment_secrets
              environment_variables: *common_environment_variables
    preview_docs:
      title: Preview docs (slurm_operator)
      jobs:
        docs:
          title: Build and Upload docs preview (slurm_operator)
          task: common/npm/run
          input:
            config:
              script: release:docs
              secret_environment_variables: *common_environment_secrets
              environment_variables:
                <<: *common_environment_variables
                REVISION: "rev/pr-${to_string(not_null(context.launch_pull_request_info.pull_request.id, ''))}"
        update-pr:
          title: Update PR description (slurm_operator)
          task: common/npm/run
          needs: docs
          input:
            config:
              script: update-pr:docs
              environment_variables:
                <<: *common_environment_variables
                pullRequestId: ${to_string(not_null(context.launch_pull_request_info.pull_request.id, ''))}
                CLOUD_ID: yc.ui-common-resources.service-cloud
                FOLDER_ID: yc.ui-common-resources.service-folder
                ENDPOINT: api.nemax.nebius.cloud:443
              secret_environment_variables:
                SA_KEY: secret/users/svc-ui-ci@nebius.com/secrets#robot_sa_key_ai

